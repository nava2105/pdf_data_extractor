{% extends "base.html" %}

{% block title %}Upload and Ask{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <h2>Upload a PDF</h2>
        <form action="/upload" method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <input class="form-control" type="file" name="file" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>
    <div class="col-md-6">
        <h2>Available PDFs</h2>
        <ul class="list-group">
            {% for file in files %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ file }}
                    <div>
                        <button class="btn btn-success view-response-btn" data-filename="{{ file }}">View Saved Response</button>
                        <button class="btn btn-info ask-btn" data-filename="{{ file }}">Ask Again</button>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
<h3 class="mt-4">Answer:</h3>
<p id="answer"></p>
<script>
    document.querySelectorAll(".ask-btn").forEach(button => {
        button.addEventListener("click", async function() {
            let filename = this.getAttribute("data-filename");
            let response = await fetch("/ask", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filename })
            });
            let data = await response.json();
            document.getElementById("answer").innerText = data.answer;
        });
    });

    document.querySelectorAll(".view-response-btn").forEach(button => {
        button.addEventListener("click", async function() {
            let filename = this.getAttribute("data-filename");
            let response = await fetch("/responses?filename=" + filename);
            let data = await response.json();
            document.getElementById("answer").innerText = data.answer || "No saved response found.";
        });
    });
</script>
<div class="mt-4">
    <button class="btn btn-secondary" id="export-csv">Export all to CSV</button>
</div>

<script>
    document.getElementById("export-csv").addEventListener("click", function () {
        window.location.href = "/export_csv";
    });
</script>
{% endblock %}
